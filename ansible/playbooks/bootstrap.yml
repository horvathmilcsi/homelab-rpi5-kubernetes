- name: Bootstrap Raspberry Pi for k3s
  hosts: localhost
  become: yes

  pre_tasks:
    - name: Set or replace cgroup_memory=1
      import_tasks: ../roles/set_replace_key_value/tasks/main.yml
      vars:
        cmdline_file: "/boot/firmware/cmdline.txt"
        original_keyword: "cgroup_memory"
        replacement_value: "cgroup_memory=1"
      notify: Reboot if cmdline changed

    - name: Set or replace cgroup_enable=memory
      import_tasks: ../roles/set_replace_key_value/tasks/main.yml
      vars:
        cmdline_file: "/boot/firmware/cmdline.txt"
        original_keyword: "cgroup_enable"
        replacement_value: "cgroup_enable=memory"
      notify: Reboot if cmdline changed

    - name: Flush handlers to reboot immediately if needed
      meta: flush_handlers

  handlers:
    - name: Reboot if cmdline changed
      become: yes
      ansible.builtin.shell: "sleep 2 && shutdown -r now 'Rebooting due to /boot/firmware/cmdline.txt changes. After reboot run this script/playbook again to continue the install process'"

  roles:
    - common   # OS updates, install Midnight Commander
    - k3s      # Install k3s
    - helm     # Install Helm
    - portainer # Install portainer (via Helm)
